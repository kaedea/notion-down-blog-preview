name: Deploy Homepages

on:
  push:
    branches:
      - release/deploy
  workflow_dispatch:

permissions:
  contents: read

jobs:
  deploy-homepages:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout blog-preview repository
        uses: actions/checkout@v4
      
      - name: Checkout HEAD (reset to main)
        run: |
          echo "Checkout HEAD"
          git reset --hard origin/main
      
      - name: Clone kaedea.github.io repository
        run: |
          echo "Clone kaedea.github.io"
          git clone -b circleci-bot https://github.com/kaedea/kaedea.github.io.git deploy
          cd deploy
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Copy preview pages into kaedea.github.io
        run: |
          echo "Copy preview pages into kaedea.github.io"
          cp -rv docs/. deploy
          ls -l deploy
          
          echo "Configure CNAME"
          if [ -f "deploy/CNAME" ]; then
              rm deploy/CNAME
          fi
          echo "kaedea.com" > deploy/CNAME
          
          echo "Configure robots.txt"
          if [ -f "deploy/robots.txt" ]; then
              rm deploy/robots.txt
          fi
      
      - name: Check for modifications
        id: check_changes
        run: |
          cd deploy
          pwd && ls -l
          ret=$(git status)
          echo "git status: ${ret}"
          has_modified=true
          if [[ $ret == *"nothing to commit"* ]]; then
              has_modified=false
          fi
          echo "has_modified: ${has_modified}"
          echo "has_modified=${has_modified}" >> $GITHUB_OUTPUT
          
          if [ "$has_modified" == "false" ]; then
              echo "Nothing modified, will skip push."
          fi
      
      - name: Commit and push to kaedea.github.io
        if: steps.check_changes.outputs.has_modified == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          cd deploy
          pwd && ls -l
          git add *
          git status
          git commit -a -m "GitHub Actions deploy homepages - ${{ github.run_number }}"
          git push --force --quiet "https://${GH_TOKEN}@github.com/kaedea/kaedea.github.io.git" circleci-bot:circleci-bot
          echo "Deploy success üç∫"
      
      - name: Create Pull Request to master
        if: steps.check_changes.outputs.has_modified == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          echo "=== Creating PR from circleci-bot to master ==="
          
          # Check if PR already exists
          existing_pr=$(curl -s -H "Authorization: token ${GH_TOKEN}" \
            "https://api.github.com/repos/kaedea/kaedea.github.io/pulls?state=open&head=kaedea:circleci-bot&base=master" \
            | jq -r '.[0].number // empty')
          
          if [ -n "$existing_pr" ]; then
            echo "‚úÖ PR #${existing_pr} already exists, skipping creation"
            echo "PR URL: https://github.com/kaedea/kaedea.github.io/pull/${existing_pr}"
          else
            echo "Creating new PR..."
            pr_response=$(curl -s -X POST \
              -H "Authorization: token ${GH_TOKEN}" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/kaedea/kaedea.github.io/pulls \
              -d @- << EOF
          {
            "title": "Deploy homepages - Run ${{ github.run_number }}",
            "body": "Automated deployment from GitHub Actions\n\n**Source:** notion-down-blog-preview\n**Workflow:** ${{ github.workflow }}\n**Run:** ${{ github.run_number }}\n**Commit:** ${{ github.sha }}\n\nThis PR merges the latest homepage updates from the circleci-bot branch to master.",
            "head": "circleci-bot",
            "base": "master"
          }
          EOF
            )
            
            pr_number=$(echo "$pr_response" | jq -r '.number // empty')
            pr_url=$(echo "$pr_response" | jq -r '.html_url // empty')
            
            if [ -n "$pr_number" ]; then
              echo "‚úÖ PR #${pr_number} created successfully"
              echo "PR URL: ${pr_url}"
            else
              echo "‚ö†Ô∏è  Failed to create PR or PR already exists"
              echo "Response: $pr_response"
            fi
          fi
