<!DOCTYPE HTML>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  
  <title>MultiDex å·¥ä½œåŸç†åˆ†æå’Œä¼˜åŒ–æ–¹æ¡ˆ | Kaede Akatsuki | ä¸­äºŒç—…ä¹Ÿè¦å¼€å‘ Android</title>

  
  <meta name="author" content="Kaede Akatsuki">
  

  
  <meta name="description" content="A TASTE OF ACG (Anime/Coding/Games).">
  

  
  
  <meta name="keywords" content="Android,æºç åˆ†æ,MultiDex">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="MultiDex å·¥ä½œåŸç†åˆ†æå’Œä¼˜åŒ–æ–¹æ¡ˆ">

  <meta property="og:site_name" content="Kaede Akatsuki">

  
  <meta property="og:image" content="/favicon.ico">
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="Kaede Akatsuki" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  
  <link href="https://fonts.lug.ustc.edu.cn/css?family=Lato|Rubik" rel="stylesheet">
  <script src="/js/pangu-407.min.js"></script>
</head>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    pangu.autoSpacingPage();
  });
</script>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">Kaede Akatsuki</a>
    </h1>
    <p class="site-description">ä¸­äºŒç—…ä¹Ÿè¦å¼€å‘ Android</p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/archives">å½’æ¡£</a></li>
      
        <li><a href="/categories">åˆ†ç±»</a></li>
      
        <li><a href="/about">å…³äº</a></li>
      
        <li><a href="/atom.xml">è®¢é˜…</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    <article>

  
    
    <h3 class="article-title"><span>MultiDex å·¥ä½œåŸç†åˆ†æå’Œä¼˜åŒ–æ–¹æ¡ˆ</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2016/11/11/android/multidex-source-code/" rel="bookmark">
        <time class="entry-date published" datetime="2016-11-11T00:00:00.000Z">
          2016-11-11
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        

<script type="text/javascript">
    function convertRemToPixels(rem) {    
        return rem * parseFloat(getComputedStyle(document.documentElement).fontSize);
    }
    window.onscroll = function() {
        var scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
        if (scrollTop > convertRemToPixels(40)) {
            document.getElementsByClassName('toc-article')[0].style.visibility = 'visible';
        } else {
            document.getElementsByClassName('toc-article')[0].style.visibility = 'hidden';
        }
    }
</script>


<div id="toc" class="toc-article">
      <div class="toc-content">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Dex-çš„å·¥ä½œæœºåˆ¶"><span class="toc-text">Dex çš„å·¥ä½œæœºåˆ¶</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#åˆ›å»º-DexFile-å¯¹è±¡"><span class="toc-text">åˆ›å»º DexFile å¯¹è±¡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#åŠ è½½-Dex-æ–‡ä»¶é‡Œçš„ç±»"><span class="toc-text">åŠ è½½ Dex æ–‡ä»¶é‡Œçš„ç±»</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MultiDex-çš„å·¥ä½œæœºåˆ¶"><span class="toc-text">MultiDex çš„å·¥ä½œæœºåˆ¶</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#å·¥ä½œæµç¨‹"><span class="toc-text">å·¥ä½œæµç¨‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#æºç åˆ†æ"><span class="toc-text">æºç åˆ†æ</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ä¼˜åŒ–æ–¹æ¡ˆ"><span class="toc-text">ä¼˜åŒ–æ–¹æ¡ˆ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#PreMultiDex-æ–¹æ¡ˆ"><span class="toc-text">PreMultiDex æ–¹æ¡ˆ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#å¼‚æ­¥-MultiDex-æ–¹æ¡ˆ"><span class="toc-text">å¼‚æ­¥ MultiDex æ–¹æ¡ˆ</span></a></li></ol></li></ol>
      </div>
</div>
<style>
        .toc-level-3 i,
        .toc-level-3 ol {
            display: none !important;
        }
    </style>



        <p>åŠ¨æ€åŠ è½½æŠ€æœ¯ï¼ˆæ’ä»¶åŒ–ï¼‰ç³»åˆ—å·²ç»å‘äº†æœ‰ä¸€æ®µæ—¶é—´äº†ï¼Œä¸è¿‡ UP ä¸»æˆ‘å¹¶æ²¡æœ‰æ”¾å¼ƒæ²»ç–—å“ˆï¼Œç›¸ä¿¡åœ¨ä¸å°±çš„æœªæ¥å°±å¯ä»¥çœ‹åˆ° â€œç³»ç»Ÿ Api Hook æ¨¡å¼â€ å’Œæ’ä»¶åŒ–æ¡†æ¶ Frontia çš„æ›´æ–°äº†ã€‚ä»Šå¤©è¦è®²çš„æ˜¯åŠ¨æ€åŠ è½½æŠ€æœ¯çš„äº²æˆš â€”â€” MultiDexã€‚ä»–ä»¬çš„æ ¸å¿ƒåŸç†ä¹‹ä¸€éƒ½æ˜¯ dex æ–‡ä»¶çš„åŠ è½½ã€‚</p>
<p>MultiDex æ˜¯ Google ä¸ºäº†è§£å†³ â€œ<strong>65535 æ–¹æ³•æ•°è¶…æ ‡ </strong>â€ ä»¥åŠ â€œ<strong>INSTALL_FAILED_DEXOPT</strong>â€ é—®é¢˜è€Œå¼€å‘çš„ä¸€ä¸ª Support åº“ï¼Œå…·ä½“å¦‚ä½•ä½¿ç”¨ MultiDex ç°åœ¨å¸‚é¢å·²ç»æœ‰ä¸€å¤§å †æ•™ç¨‹ï¼ˆå¯ä»¥å‚è€ƒ <a href="http://kaedea.com/2015/09/02/android/enable-multidex/">ç»™ App å¯ç”¨ MultiDex åŠŸèƒ½</a>ï¼‰ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚è¿™ç¯‡æ—¥å¿—ä¸»è¦æ˜¯é…åˆæºç åˆ†æ MultiDex çš„å·¥ä½œåŸç†ï¼Œä»¥åŠæä¾›ä¸€äº› MultiDex ä¼˜åŒ–çš„æ–¹æ¡ˆã€‚</p>
<a id="more"></a>
<h2 id="Dex-çš„å·¥ä½œæœºåˆ¶"><a href="#Dex-çš„å·¥ä½œæœºåˆ¶" class="headerlink" title="Dex çš„å·¥ä½œæœºåˆ¶"></a>Dex çš„å·¥ä½œæœºåˆ¶</h2><p>ç­‰ç­‰ï¼Œè¿™ä¸ªç« èŠ‚è®²çš„ä¸æ˜¯ MultiDex å—ï¼Œæ€ä¹ˆå˜æˆ Dex äº†ï¼Ÿæ²¡é”™å“ˆï¼Œæ²¡æœ‰ Dexï¼Œå“ªæ¥çš„ MultiDexã€‚åœ¨ Android ä¸­ï¼Œå¯¹ Dex æ–‡ä»¶æ“ä½œå¯¹åº”çš„ç±»å«åš DexFileã€‚åœ¨ <a href="http://kaedea.com/2016/02/07/android-dynamical-loading-02-classloader/">CLASSLOADER çš„å·¥ä½œæœºåˆ¶</a> ä¸­ï¼Œæˆ‘ä»¬è¯´åˆ°ï¼š</p>
<blockquote>
<p>å¯¹äº Java ç¨‹åºæ¥è¯´ï¼Œç¼–å†™ç¨‹åºå°±æ˜¯ç¼–å†™ç±»ï¼Œè¿è¡Œç¨‹åºä¹Ÿå°±æ˜¯è¿è¡Œç±»ï¼ˆç¼–è¯‘å¾—åˆ°çš„ class æ–‡ä»¶ï¼‰ï¼Œå…¶ä¸­èµ·åˆ°å…³é”®ä½œç”¨çš„å°±æ˜¯ç±»åŠ è½½å™¨ ClassLoaderã€‚</p>
</blockquote>
<p>Android ç¨‹åºçš„æ¯ä¸€ä¸ª Class éƒ½æ˜¯ç”± ClassLoader#loadClass æ–¹æ³•åŠ è½½è¿›å†…å­˜çš„ï¼Œæ›´å‡†ç¡®æ¥è¯´ï¼Œ<strong> ä¸€ä¸ª ClassLoader å®ä¾‹ä¼šæœ‰ä¸€ä¸ªæˆ–è€…å¤šä¸ª DexFile å®ä¾‹ </strong>ï¼Œè°ƒç”¨äº† ClassLoader#loadClass ä¹‹åï¼ŒClassLoader ä¼šé€šè¿‡ç±»åï¼Œåœ¨è‡ªå·±çš„ DexFile æ•°ç»„é‡Œé¢æŸ¥æ‰¾æœ‰æ²¡æœ‰é‚£ä¸ª DexFile å¯¹è±¡é‡Œé¢å­˜åœ¨è¿™ä¸ªç±»ï¼Œå¦‚æœéƒ½æ²¡æœ‰å°±æŠ› ClassNotFound å¼‚å¸¸ã€‚ClassLoader é€šè¿‡è°ƒç”¨ DexFile çš„ä¸€ä¸ªå« defineClass çš„ Native æ–¹æ³•å»åŠ è½½æŒ‡å®šçš„ç±»ï¼Œè¿™ç‚¹ä¸ JVM ç•¥æœ‰ä¸åŒï¼Œåè€…æ˜¯ç›´æ¥è°ƒç”¨ ClassLoader#defineCLass æ–¹æ³•ï¼Œåæ­£æœ€åå®é™…åŠ è½½ç±»çš„æ–¹æ³•éƒ½å« defineClass å°±æ²¡é”™äº†ğŸŒã€‚</p>
<h3 id="åˆ›å»º-DexFile-å¯¹è±¡"><a href="#åˆ›å»º-DexFile-å¯¹è±¡" class="headerlink" title="åˆ›å»º DexFile å¯¹è±¡"></a>åˆ›å»º DexFile å¯¹è±¡</h3><p>é¦–å…ˆæ¥çœ‹çœ‹é€  DexFile å¯¹è±¡çš„æ„æ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DexFile</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mCookie;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String mFileName;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DexFile</span><span class="params">(File file)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(file.getPath());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DexFile</span><span class="params">(String fileName)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        mCookie = openDexFile(fileName, <span class="keyword">null</span>, <span class="number">0</span>);</span><br><span class="line">        mFileName = fileName;</span><br><span class="line">        guard.open(<span class="string">"close"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">DexFile</span><span class="params">(String sourceName, String outputName, <span class="keyword">int</span> flags)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        mCookie = openDexFile(sourceName, outputName, flags);</span><br><span class="line">        mFileName = sourceName;</span><br><span class="line">        guard.open(<span class="string">"close"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">public</span> DexFile <span class="title">loadDex</span><span class="params">(String sourcePathName, String outputPathName,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> flags)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DexFile(sourcePathName, outputPathName, flags);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Class <span class="title">loadClass</span><span class="params">(String name, ClassLoader loader)</span> </span>&#123;</span><br><span class="line">        String slashName = name.replace(<span class="string">'.'</span>, <span class="string">'/'</span>);</span><br><span class="line">        <span class="keyword">return</span> loadClassBinaryName(slashName, loader);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Class <span class="title">loadClassBinaryName</span><span class="params">(String name, ClassLoader loader)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> defineClass(name, loader, mCookie);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">static</span> Class <span class="title">defineClass</span><span class="params">(String name, ClassLoader loader, <span class="keyword">int</span> cookie)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">native</span> <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">openDexFile</span><span class="params">(String sourceName, String outputName,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> flags)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">native</span> <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">openDexFile</span><span class="params">(<span class="keyword">byte</span>[] fileContents)</span></span></span><br><span class="line"><span class="function">    ...</span></span><br><span class="line"><span class="function">&#125;</span></span><br></pre></td></tr></table></figure>
<p>é€šè¿‡ä»¥å‰åˆ†æè¿‡çš„æºç ï¼Œæˆ‘ä»¬çŸ¥é“ ClassLoader ä¸»è¦æ˜¯é€šè¿‡ DexFile.loadDex è¿™ä¸ªé™æ€æ–¹æ³•æ¥åˆ›å»ºå®ƒéœ€è¦çš„ DexFile å®ä¾‹çš„ï¼Œè¿™é‡Œåˆ›å»º DexFile çš„æ—¶å€™ï¼Œä¿å­˜äº† Dex æ–‡ä»¶çš„æ–‡ä»¶è·¯å¾„ mFileNameï¼Œ<strong> åŒæ—¶è°ƒç”¨äº† openDexFile çš„ Native æ–¹æ³•æ‰“å¼€ Dex æ–‡ä»¶ </strong> å¹¶è¿”å›äº†ä¸€ä¸ª mCookie çš„æ•´å‹å˜é‡ï¼ˆæˆ‘ä¸çŸ¥é“è¿™ä¸ªå¹²å•¥ç”¨çš„ï¼Œæˆ‘çŒœå®ƒæ˜¯ä¸€ä¸ª C++ ç”¨çš„èµ„æºå¥æŸ„ï¼Œç”¨äº Native å±‚è®¿é—®å…·ä½“çš„ Dex æ–‡ä»¶ï¼‰ã€‚åœ¨ Native å±‚çš„ openDexFile æ–¹æ³•é‡Œï¼Œä¸»è¦åšäº†æ£€æŸ¥å½“å‰åˆ›å»ºæ¥çš„ Dex æ–‡ä»¶æ˜¯å¦æ˜¯æœ‰æ•ˆçš„ Dex æ–‡ä»¶ï¼Œè¿˜æ˜¯æ˜¯ä¸€ä¸ªå¸¦æœ‰ Dex æ–‡ä»¶çš„å‹ç¼©åŒ…ï¼Œè¿˜æ˜¯ä¸€ä¸ªæ— æ•ˆçš„ Dex æ–‡ä»¶ã€‚</p>
<h3 id="åŠ è½½-Dex-æ–‡ä»¶é‡Œçš„ç±»"><a href="#åŠ è½½-Dex-æ–‡ä»¶é‡Œçš„ç±»" class="headerlink" title="åŠ è½½ Dex æ–‡ä»¶é‡Œçš„ç±»"></a>åŠ è½½ Dex æ–‡ä»¶é‡Œçš„ç±»</h3><p>åŠ è½½ç±»çš„æ—¶å€™ï¼ŒClassLoader åˆæ˜¯é€šè¿‡ DexFile#loadClass è¿™ä¸ªæ–¹æ³•æ¥å®Œæˆçš„ï¼Œè¿™ä¸ªæ–¹æ³•é‡Œè°ƒç”¨äº† defineClass è¿™ä¸ª Native æ–¹æ³•ï¼Œ<strong> çœ‹æ¥ DexFile æ‰æ˜¯åŠ è½½ Class çš„å…·ä½“ APIï¼ŒåŠ è½½ Dex æ–‡ä»¶å’ŒåŠ è½½å…·ä½“ Class éƒ½æ˜¯é€šè¿‡ Native æ–¹æ³•å®Œæˆ </strong>ï¼ŒClassLoader æœ‰ç‚¹åä¸å‰¯å®å•Šã€‚</p>
<h2 id="MultiDex-çš„å·¥ä½œæœºåˆ¶"><a href="#MultiDex-çš„å·¥ä½œæœºåˆ¶" class="headerlink" title="MultiDex çš„å·¥ä½œæœºåˆ¶"></a>MultiDex çš„å·¥ä½œæœºåˆ¶</h2><p>å½“ä¸€ä¸ª Dex æ–‡ä»¶å¤ªè‚¥çš„æ—¶å€™ï¼ˆæ–¹æ³•æ•°ç›®å¤ªå¤šã€æ–‡ä»¶å¤ªå¤§ï¼‰ï¼Œåœ¨æ‰“åŒ… Apk æ–‡ä»¶çš„æ—¶å€™å°±ä¼šå‡ºé—®é¢˜ï¼Œå°±ç®—æ‰“åŒ…çš„æ—¶å€™ä¸å‡ºé—®é¢˜ï¼Œåœ¨ Android 5.0 ä»¥ä¸‹è®¾å¤‡ä¸Šå®‰è£…æˆ–è¿è¡Œ Apk ä¹Ÿä¼šå‡ºé—®é¢˜ï¼ˆå…·ä½“åŸå› å¯ä»¥å‚è€ƒ <a href="http://kaedea.com/2015/09/02/android/enable-multidex/">ç»™ App å¯ç”¨ MultiDex åŠŸèƒ½</a>ï¼‰ã€‚æ—¢ç„¶ä¸€ä¸ª Dex æ–‡ä»¶ä¸è¡Œçš„è¯ï¼Œé‚£å°±æŠŠè¿™ä¸ªç¡•å¤§çš„ Dex æ–‡ä»¶æ‹†åˆ†æˆè‹¥å¹²ä¸ªå°çš„ Dex æ–‡ä»¶ï¼Œåˆšå¥½ä¸€ä¸ª ClassLoader å¯ä»¥æœ‰å¤šä¸ª DexFileï¼Œè¿™å°±æ˜¯ MultiDex çš„åŸºæœ¬è®¾è®¡æ€è·¯ã€‚</p>
<h3 id="å·¥ä½œæµç¨‹"><a href="#å·¥ä½œæµç¨‹" class="headerlink" title="å·¥ä½œæµç¨‹"></a>å·¥ä½œæµç¨‹</h3><p>MultiDex çš„å·¥ä½œæµç¨‹å…·ä½“åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼Œä¸€ä¸ªéƒ¨åˆ†æ˜¯æ‰“åŒ…æ„å»º Apk çš„æ—¶å€™ï¼Œå°† Dex æ–‡ä»¶æ‹†åˆ†æˆè‹¥å¹²ä¸ªå°çš„ Dex æ–‡ä»¶ï¼Œè¿™ä¸ª Android Studio å·²ç»å¸®æˆ‘ä»¬åšäº†ï¼ˆè®¾ç½® â€œmultiDexEnabled trueâ€ï¼‰ï¼Œå¦ä¸€éƒ¨åˆ†å°±æ˜¯åœ¨å¯åŠ¨ Apk çš„æ—¶å€™ï¼ŒåŒæ—¶åŠ è½½å¤šä¸ª Dex æ–‡ä»¶ï¼ˆå…·ä½“æ˜¯åŠ è½½ Dex æ–‡ä»¶ä¼˜åŒ–åçš„ Odex æ–‡ä»¶ï¼Œä¸è¿‡æ–‡ä»¶åè¿˜æ˜¯.dexï¼‰ï¼Œè¿™ä¸€éƒ¨åˆ†å·¥ä½œä» Android 5.0 å¼€å§‹ç³»ç»Ÿå·²ç»å¸®æˆ‘ä»¬åšäº†ï¼Œä½†æ˜¯åœ¨ Android 5.0 ä»¥å‰è¿˜æ˜¯éœ€è¦é€šè¿‡ MultiDex Support åº“æ¥æ”¯æŒï¼ˆMultiDex.install (Context)ï¼‰ã€‚</p>
<p>æ‰€ä»¥æˆ‘ä»¬éœ€è¦å…³å¿ƒçš„æ˜¯ç¬¬äºŒéƒ¨åˆ†ï¼Œè¿™ä¸ªè¿‡ç¨‹çš„ç®€å•ç¤ºæ„æµç¨‹å›¾å¦‚ä¸‹ã€‚</p>
<p><img src="/assets/4d91c7cd_4563_4391_a0a2_9ef1d8624c9c_untitled.png" alt></p>
<p>ï¼ˆå›¾ä¸­çº¢è‰²éƒ¨åˆ†ä¸ºè€—æ—¶æ¯”è¾ƒå¤§çš„åœ°æ–¹ï¼‰</p>
<h3 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h3><p>ç°åœ¨å®˜æ–¹å·²ç»éƒ¨ç½²çš„ MultiDex Support ç‰ˆæœ¬æ˜¯ <code>com.android.support:multidex:1.0.1</code>ï¼Œä½†æ˜¯ç°åœ¨ä»“åº“çš„ master åˆ†æ”¯å·²ç»æœ‰äº†è®¸å¤šæ–°çš„æäº¤ï¼ˆå…¶ä¸­æœ€æ˜æ˜¾çš„åŒºåˆ«æ˜¯åŠ å…¥äº† FileLock æ¥æ§åˆ¶å¤šè¿›ç¨‹åŒæ­¥é—®é¢˜ï¼‰ï¼Œæ‰€ä»¥è¿™é‡Œåˆ†æçš„æºç éƒ½æ˜¯æœ€æ–°çš„ master åˆ†æ”¯ä¸Šçš„ã€‚</p>
<p>MultiDex Support çš„å…¥å£æ˜¯ <code>MultiDex.install (Context)</code>ï¼Œå…ˆä»è¿™é‡Œå…¥æ‰‹å§ã€‚ï¼ˆè¿™æ¬¡æˆ‘æŠŠå…·ä½“çš„åˆ†æéƒ½å†™åœ¨ä»£ç çš„æ³¨é‡Šäº†ï¼Œè¿™æ ·çœ‹æ˜¯ä¸æ˜¯æ›´ç®€æ´æ˜äº†äº›ï¼Ÿï¼‰</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">install</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        Log.i(TAG, <span class="string">"install"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. åˆ¤è¯»æ˜¯å¦éœ€è¦æ‰§è¡ŒMultiDexã€‚if (IS_VM_MULTIDEX_CAPABLE) &#123;</span></span><br><span class="line">            Log.i(TAG, <span class="string">"VM has multidex support, MultiDex support library is disabled."</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (Build.VERSION.SDK_INT &lt; MIN_SDK_VERSION) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Multi dex installation failed. SDK "</span> + Build.VERSION.SDK_INT</span><br><span class="line">                    + <span class="string">" is unsupported. Min SDK version is "</span> + MIN_SDK_VERSION + <span class="string">"."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ApplicationInfo applicationInfo = getApplicationInfo(context);</span><br><span class="line">            <span class="keyword">if</span> (applicationInfo == <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="comment">// Looks like running on a test Context, so just return without patching.return;</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. å¦‚æœè¿™ä¸ªæ–¹æ³•å·²ç»è°ƒç”¨è¿‡ä¸€æ¬¡ï¼Œå°±ä¸èƒ½å†è°ƒç”¨äº†ã€‚synchronized (installedApk) &#123;</span></span><br><span class="line">                String apkPath = applicationInfo.sourceDir;</span><br><span class="line">                <span class="keyword">if</span> (installedApk.contains(apkPath)) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                installedApk.add(apkPath);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. å¦‚æœå½“å‰Androidç‰ˆæœ¬å·²ç»è‡ªèº«æ”¯æŒäº†MultiDexï¼Œä¾ç„¶å¯ä»¥æ‰§è¡ŒMultiDexæ“ä½œï¼Œ// ä½†æ˜¯ä¼šæœ‰è­¦å‘Šã€‚if (Build.VERSION.SDK_INT &gt; MAX_SUPPORTED_SDK_VERSION) &#123;</span></span><br><span class="line">                    Log.w(TAG, <span class="string">"MultiDex is not guaranteed to work in SDK version "</span></span><br><span class="line">                            + Build.VERSION.SDK_INT + <span class="string">": SDK version higher than "</span></span><br><span class="line">                            + MAX_SUPPORTED_SDK_VERSION + <span class="string">" should be backed by "</span></span><br><span class="line">                            + <span class="string">"runtime with built-in multidex capabilty but it's not the "</span></span><br><span class="line">                            + <span class="string">"case here: java.vm.version=\""</span></span><br><span class="line">                            + System.getProperty(<span class="string">"java.vm.version"</span>) + <span class="string">"\""</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. è·å–å½“å‰çš„ClassLoaderå®ä¾‹ï¼Œåé¢è¦åšçš„å·¥ä½œï¼Œå°±æ˜¯æŠŠå…¶ä»–dexæ–‡ä»¶åŠ è½½åï¼Œ// æŠŠå…¶DexFileå¯¹è±¡æ·»åŠ åˆ°è¿™ä¸ªClassLoaderå®ä¾‹é‡Œå°±å®Œäº‹äº†ã€‚</span></span><br><span class="line">                ClassLoader loader;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    loader = context.getClassLoader();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">                    Log.w(TAG, <span class="string">"Failure while trying to obtain Context class loader. "</span> +</span><br><span class="line">                            <span class="string">"Must be running in test mode. Skip patching."</span>, e);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (loader == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Log.e(TAG,</span><br><span class="line">                            <span class="string">"Context class loader is null. Must be running in test mode. "</span></span><br><span class="line">                            + <span class="string">"Skip patching."</span>);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">// 5. æ¸…é™¤æ—§çš„dexæ–‡ä»¶ï¼Œæ³¨æ„è¿™é‡Œä¸æ˜¯æ¸…é™¤ä¸Šæ¬¡åŠ è½½çš„dexæ–‡ä»¶ç¼“å­˜ã€‚// è·å–dexç¼“å­˜ç›®å½•æ˜¯ï¼Œä¼šä¼˜å…ˆè·å–/data/data/&lt;package&gt;/code-cacheä½œä¸ºç¼“å­˜ç›®å½•ã€‚// å¦‚æœè·å–å¤±è´¥ï¼Œåˆ™ä½¿ç”¨/data/data/&lt;package&gt;/files/code-cacheç›®å½•ã€‚// è¿™é‡Œæ¸…é™¤çš„æ˜¯ç¬¬äºŒä¸ªç›®å½•ã€‚</span></span><br><span class="line">                  clearOldDexDir(context);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                  Log.w(TAG, <span class="string">"Something went wrong when trying to clear old MultiDex extraction, "</span></span><br><span class="line">                      + <span class="string">"continuing without cleaning."</span>, t);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 6. è·å–ç¼“å­˜ç›®å½•ï¼ˆ/data/data/&lt;package&gt;/code-cacheï¼‰ã€‚</span></span><br><span class="line">                File dexDir = getDexDir(context, applicationInfo);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 7. åŠ è½½ç¼“å­˜æ–‡ä»¶ï¼ˆå¦‚æœæœ‰ï¼‰ã€‚</span></span><br><span class="line">                List&lt;File&gt; files = MultiDexExtractor.load(context, applicationInfo, dexDir, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 8. æ£€æŸ¥ç¼“å­˜çš„dexæ˜¯å¦å®‰å…¨if (checkValidZipFiles(files)) &#123;</span></span><br><span class="line"><span class="comment">// 9. å®‰è£…ç¼“å­˜çš„dex</span></span><br><span class="line">                    installSecondaryDexes(loader, dexDir, files);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">// 9. ä»apkå‹ç¼©åŒ…é‡Œé¢æå–dexæ–‡ä»¶</span></span><br><span class="line">                    Log.w(TAG, <span class="string">"Files were not valid zip files.  Forcing a reload."</span>);</span><br><span class="line">                    files = MultiDexExtractor.load(context, applicationInfo, dexDir, <span class="keyword">true</span>);</span><br><span class="line">                    <span class="keyword">if</span> (checkValidZipFiles(files)) &#123;</span><br><span class="line"><span class="comment">// 10. å®‰è£…æå–çš„dex</span></span><br><span class="line">                        installSecondaryDexes(loader, dexDir, files);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Zip files were not valid."</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            Log.e(TAG, <span class="string">"Multidex installation failure"</span>, e);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Multi dex installation failed ("</span> + e.getMessage() + <span class="string">")."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        Log.i(TAG, <span class="string">"install done"</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>å…·ä½“ä»£ç çš„åˆ†æå·²ç»åœ¨ä¸Šé¢ä»£ç çš„æ³¨é‡Šé‡Œç»™å‡ºäº†ï¼Œä»è¿™é‡Œæˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œæ•´ä¸ª MultiDex.install (Context) çš„è¿‡ç¨‹ä¸­ï¼Œå…³é”®çš„æ­¥éª¤å°±æ˜¯ <code>MultiDexExtractor#load</code> æ–¹æ³•å’Œ <code>MultiDex#installSecondaryDexes</code> æ–¹æ³•ã€‚</p>
<p>ï¼ˆè¿™éƒ¨åˆ†æ˜¯é¢˜å¤–è¯ï¼‰å…¶ä¸­æœ‰ä¸ª <strong>MultiDex#clearOldDexDir (Context)**</strong> æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•çš„ä½œç”¨æ˜¯åˆ é™¤ <strong>**/data/data//files/code-cache</strong>ï¼Œä¸€å¼€å§‹æˆ‘ä»¥ä¸ºè¿™ä¸ªæ–¹æ³•æ˜¯åˆ é™¤ä¸Šä¸€æ¬¡æ‰§è¡Œ MultiDex åçš„ç¼“å­˜æ–‡ä»¶ï¼Œä¸è¿‡è¿™æ˜æ˜¾ä¸å¯¹ï¼Œä¸å¯èƒ½æ¯æ¬¡ MultiDex éƒ½é‡æ–°è§£å‹ dex æ–‡ä»¶ä¸€è¾¹ï¼Œè¿™æ ·æ¯æ¬¡å¯åŠ¨ä¼šå¾ˆè€—æ—¶ï¼Œ<strong> åªæœ‰ç¬¬ä¸€æ¬¡å†·å¯åŠ¨çš„æ—¶å€™æ‰éœ€è¦è§£å‹ dex æ–‡ä»¶ </strong>ã€‚åæ¥æˆ‘åˆæƒ³æ˜¯ä¸æ˜¯ä»¥å‰æ—§ç‰ˆçš„ MultiDex æ›¾ç»æŠŠç¼“å­˜æ–‡ä»¶æ”¾åœ¨è¿™ä¸ªç›®å½•é‡Œï¼Œç°åœ¨æ–°ç‰ˆæœ¬åªæ˜¯æ¸…é™¤ä»¥å‰æ—§ç‰ˆçš„é—ç•™æ–‡ä»¶ï¼Ÿä½†æ˜¯æˆ‘æ‰¾éäº†æ•´ä¸ª MultiDex Repo çš„æäº¤ä¹Ÿæ²¡æœ‰è§è¿‡ç±»ä¼¼çš„æ—§ç‰ˆæœ¬ä»£ç ã€‚åé¢æˆ‘ä»”ç»†çœ‹ <strong>MultiDex#getDexDir</strong> è¿™ä¸ªæ–¹æ³•æ‰å‘ç°ï¼ŒåŸæ¥ MultiDex åœ¨è·å– dex ç¼“å­˜ç›®å½•æ˜¯ï¼Œä¼šä¼˜å…ˆè·å– <strong>/data/data//code-cache</strong> ä½œä¸ºç¼“å­˜ç›®å½•ï¼Œå¦‚æœè·å–å¤±è´¥ï¼Œåˆ™ä½¿ç”¨ <strong>/data/data//files/code-cache</strong> ç›®å½•ï¼Œè€Œåè€…çš„ç¼“å­˜æ–‡ä»¶ä¼šåœ¨æ¯æ¬¡ App é‡æ–°å¯åŠ¨çš„æ—¶å€™è¢«æ¸…é™¤ã€‚æ„Ÿè§‰ MultiDex è·å–ç¼“å­˜ç›®å½•çš„é€»è¾‘ä¸æ˜¯å¾ˆä¸¥è°¨ï¼Œè€Œè·å–ç¼“å­˜ç›®å½•å¤±è´¥ä¹Ÿæ˜¯ MultiDex å·¥ä½œå·¥ç¨‹ä¸­å°‘æ•°æœ‰é‡è¯•æœºåˆ¶çš„åœ°æ–¹ï¼Œçœ‹æ¥ MultiDex çœŸçš„æ˜¯ä¸€ä¸ªä¸´æ—¶çš„å…¼å®¹æ–¹æ¡ˆï¼ŒGoogle ä¹Ÿè®¸å¹¶ä¸æ‰“ç®—è®¤çœŸå¤„ç†è¿™äº›å†å²çš„é»‘é”…ã€‚</p>
<p>æ¥ä¸‹æ¥å†çœ‹çœ‹ MultiDexExtractor#load è¿™ä¸ªæ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> List&lt;File&gt; <span class="title">load</span><span class="params">(Context context, ApplicationInfo applicationInfo, File dexDir,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> forceReload)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Log.i(TAG, <span class="string">"MultiDexExtractor.load("</span> + applicationInfo.sourceDir + <span class="string">", "</span> + forceReload + <span class="string">")"</span>);</span><br><span class="line">        <span class="keyword">final</span> File sourceApk = <span class="keyword">new</span> File(applicationInfo.sourceDir);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. è·å–å½“å‰Apkæ–‡ä»¶çš„crcå€¼ã€‚long currentCrc = getZipCrc(sourceApk);</span></span><br><span class="line"><span class="comment">// Validity check and extraction must be done only while the lock file has been taken.</span></span><br><span class="line">        File lockFile = <span class="keyword">new</span> File(dexDir, LOCK_FILENAME);</span><br><span class="line">        RandomAccessFile lockRaf = <span class="keyword">new</span> RandomAccessFile(lockFile, <span class="string">"rw"</span>);</span><br><span class="line">        FileChannel lockChannel = <span class="keyword">null</span>;</span><br><span class="line">        FileLock cacheLock = <span class="keyword">null</span>;</span><br><span class="line">        List&lt;File&gt; files;</span><br><span class="line">        IOException releaseLockException = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            lockChannel = lockRaf.getChannel();</span><br><span class="line">            Log.i(TAG, <span class="string">"Blocking on lock "</span> + lockFile.getPath());</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. åŠ ä¸Šæ–‡ä»¶é”ï¼Œé˜²æ­¢å¤šè¿›ç¨‹å†²çªã€‚</span></span><br><span class="line">            cacheLock = lockChannel.lock();</span><br><span class="line">            Log.i(TAG, lockFile.getPath() + <span class="string">" locked"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. å…ˆåˆ¤æ–­æ˜¯å¦å¼ºåˆ¶é‡æ–°è§£å‹ï¼Œè¿™é‡Œç¬¬ä¸€æ¬¡ä¼šä¼˜å…ˆä½¿ç”¨å·²è§£å‹è¿‡çš„dexæ–‡ä»¶ï¼Œå¦‚æœåŠ è½½å¤±è´¥å°±å¼ºåˆ¶é‡æ–°è§£å‹ã€‚// æ­¤å¤–ï¼Œé€šè¿‡crcå’Œæ–‡ä»¶ä¿®æ”¹æ—¶é—´ï¼Œåˆ¤æ–­å¦‚æœApkæ–‡ä»¶å·²ç»è¢«ä¿®æ”¹ï¼ˆè¦†ç›–å®‰è£…ï¼‰ï¼Œå°±ä¼šè·³è¿‡ç¼“å­˜é‡æ–°è§£å‹dexæ–‡ä»¶ã€‚if (!forceReload &amp;&amp; !isModified(context, sourceApk, currentCrc)) &#123;</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. åŠ è½½ç¼“å­˜çš„dexæ–‡ä»¶</span></span><br><span class="line">                    files = loadExistingExtractions(context, sourceApk, dexDir);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">                    Log.w(TAG, <span class="string">"Failed to reload existing extracted secondary dex files,"</span></span><br><span class="line">                            + <span class="string">" falling back to fresh extraction"</span>, ioe);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5. åŠ è½½å¤±è´¥çš„è¯é‡æ–°è§£å‹ï¼Œå¹¶ä¿å­˜è§£å‹å‡ºæ¥çš„dexæ–‡ä»¶çš„ä¿¡æ¯ã€‚</span></span><br><span class="line">                    files = performExtractions(sourceApk, dexDir);</span><br><span class="line">                    putStoredApkInfo(context,</span><br><span class="line">                            getTimeStamp(sourceApk), currentCrc, files.size() + <span class="number">1</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">// 4. é‡æ–°è§£å‹ï¼Œå¹¶ä¿å­˜è§£å‹å‡ºæ¥çš„dexæ–‡ä»¶çš„ä¿¡æ¯ã€‚</span></span><br><span class="line">                Log.i(TAG, <span class="string">"Detected that extraction must be performed."</span>);</span><br><span class="line">                files = performExtractions(sourceApk, dexDir);</span><br><span class="line">                putStoredApkInfo(context, getTimeStamp(sourceApk), currentCrc, files.size() + <span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (cacheLock != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    cacheLock.release();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    Log.e(TAG, <span class="string">"Failed to release lock on "</span> + lockFile.getPath());</span><br><span class="line"><span class="comment">// Exception while releasing the lock is bad, we want to report it, but not at// the price of overriding any already pending exception.</span></span><br><span class="line">                    releaseLockException = e;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (lockChannel != <span class="keyword">null</span>) &#123;</span><br><span class="line">                closeQuietly(lockChannel);</span><br><span class="line">            &#125;</span><br><span class="line">            closeQuietly(lockRaf);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (releaseLockException != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> releaseLockException;</span><br><span class="line">        &#125;</span><br><span class="line">        Log.i(TAG, <span class="string">"load found "</span> + files.size() + <span class="string">" secondary dex files"</span>);</span><br><span class="line">        <span class="keyword">return</span> files;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªè¿‡ç¨‹ä¸»è¦æ˜¯è·å–å¯ä»¥å®‰è£…çš„ dex æ–‡ä»¶åˆ—è¡¨ï¼Œå¯ä»¥æ˜¯ä¸Šæ¬¡è§£å‹å‡ºæ¥çš„ç¼“å­˜æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥æ˜¯é‡æ–°ä» Apk åŒ…é‡Œé¢æå–å‡ºæ¥çš„ã€‚éœ€è¦æ³¨æ„çš„æ—¶ï¼Œå¦‚æœæ˜¯é‡æ–°è§£å‹ï¼Œè¿™é‡Œä¼šæœ‰æ˜æ˜¾çš„è€—æ—¶ï¼Œè€Œä¸”è§£å‹å‡ºæ¥çš„ dex æ–‡ä»¶ï¼Œä¼šè¢«å‹ç¼©æˆ.zip å‹ç¼©åŒ…ï¼Œå‹ç¼©çš„è¿‡ç¨‹ä¹Ÿä¼šæœ‰æ˜æ˜¾çš„è€—æ—¶ï¼ˆè¿™é‡Œå‹ç¼© dex æ–‡ä»¶å¯èƒ½æ˜¯é—®äº†èŠ‚çœç©ºé—´ï¼‰ã€‚</p>
<p>å¦‚æœ dex æ–‡ä»¶æ˜¯é‡æ–°è§£å‹å‡ºæ¥çš„ï¼Œåˆ™ä¼šä¿å­˜ dex æ–‡ä»¶çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬è§£å‹çš„ apk æ–‡ä»¶çš„ crc å€¼ã€ä¿®æ”¹æ—¶é—´ä»¥åŠ dex æ–‡ä»¶çš„æ•°ç›®ï¼Œä»¥ä¾¿ä¸‹ä¸€æ¬¡å¯åŠ¨ç›´æ¥ä½¿ç”¨å·²ç»è§£å‹è¿‡çš„ dex ç¼“å­˜æ–‡ä»¶ï¼Œè€Œä¸æ˜¯æ¯ä¸€æ¬¡éƒ½é‡æ–°è§£å‹ã€‚</p>
<p>éœ€è¦ç‰¹åˆ«æåˆ°çš„æ˜¯ï¼Œé‡Œé¢çš„ <strong>FileLock</strong> æ˜¯æœ€æ–°çš„ master åˆ†æ”¯é‡Œé¢æ–°åŠ è¿›å»çš„åŠŸèƒ½ï¼Œç°åœ¨æœ€æ–°çš„ <code>1.0.1</code> ç‰ˆæœ¬é‡Œé¢æ˜¯æ²¡æœ‰çš„ã€‚</p>
<p>æ— è®ºæ˜¯é€šè¿‡ä½¿ç”¨ç¼“å­˜çš„ dex æ–‡ä»¶ï¼Œè¿˜æ˜¯é‡æ–°ä» apk ä¸­è§£å‹ dex æ–‡ä»¶ï¼Œè·å– dex æ–‡ä»¶åˆ—è¡¨åï¼Œä¸‹ä¸€æ­¥å°±æ˜¯å®‰è£…ï¼ˆæˆ–è€…è¯´åŠ è½½ï¼‰è¿™äº› dex æ–‡ä»¶äº†ã€‚æœ€åçš„å·¥ä½œåœ¨ <code>MultiDex#installSecondaryDexes</code> è¿™ä¸ªæ–¹æ³•é‡Œé¢ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">installSecondaryDexes</span><span class="params">(ClassLoader loader, File dexDir, List&lt;File&gt; files)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IllegalArgumentException, IllegalAccessException, NoSuchFieldException,</span></span><br><span class="line"><span class="function">        InvocationTargetException, NoSuchMethodException, IOException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!files.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= <span class="number">19</span>) &#123;</span><br><span class="line">            V19.install(loader, files, dexDir);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= <span class="number">14</span>) &#123;</span><br><span class="line">            V14.install(loader, files, dexDir);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            V4.install(loader, files);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å› ä¸ºåœ¨ä¸åŒçš„ SDK ç‰ˆæœ¬ä¸Šï¼ŒClassLoaderï¼ˆæ›´å‡†ç¡®æ¥è¯´æ˜¯ DexClassLoaderï¼‰åŠ è½½ dex æ–‡ä»¶çš„æ–¹å¼æœ‰æ‰€ä¸åŒï¼Œæ‰€ä»¥è¿™é‡Œåšäº† V4/V14/V19 çš„å…¼å®¹ï¼ˆMagic Codeï¼‰ã€‚</p>
<p>Build.VERSION.SDK_INT &lt; 14</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Installer for platform versions 4 to 13.</span></span><br><span class="line"><span class="comment">     */</span><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">V4</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">install</span><span class="params">(ClassLoader loader, List&lt;File&gt; additionalClassPathEntries)</span></span></span><br><span class="line"><span class="function">                        <span class="keyword">throws</span> IllegalArgumentException, IllegalAccessException,</span></span><br><span class="line"><span class="function">                        NoSuchFieldException, IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span> extraSize = additionalClassPathEntries.size();</span><br><span class="line">            Field pathField = findField(loader, <span class="string">"path"</span>);</span><br><span class="line">            StringBuilder path = <span class="keyword">new</span> StringBuilder((String) pathField.get(loader));</span><br><span class="line">            String[] extraPaths = <span class="keyword">new</span> String[extraSize];</span><br><span class="line">            File[] extraFiles = <span class="keyword">new</span> File[extraSize];</span><br><span class="line">            ZipFile[] extraZips = <span class="keyword">new</span> ZipFile[extraSize];</span><br><span class="line">            DexFile[] extraDexs = <span class="keyword">new</span> DexFile[extraSize];</span><br><span class="line">            <span class="keyword">for</span> (ListIterator&lt;File&gt; iterator = additionalClassPathEntries.listIterator();</span><br><span class="line">                    iterator.hasNext();) &#123;</span><br><span class="line">                File additionalEntry = iterator.next();</span><br><span class="line">                String entryPath = additionalEntry.getAbsolutePath();</span><br><span class="line">                path.append(<span class="string">':'</span>).append(entryPath);</span><br><span class="line">                <span class="keyword">int</span> index = iterator.previousIndex();</span><br><span class="line">                extraPaths[index] = entryPath;</span><br><span class="line">                extraFiles[index] = additionalEntry;</span><br><span class="line">                extraZips[index] = <span class="keyword">new</span> ZipFile(additionalEntry);</span><br><span class="line">                extraDexs[index] = DexFile.loadDex(entryPath, entryPath + <span class="string">".dex"</span>, <span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿™ä¸ªç‰ˆæœ¬æ˜¯æœ€ç®€å•çš„ã€‚// åªéœ€è¦åˆ›å»ºDexFileå¯¹è±¡åï¼Œä½¿ç”¨åå°„çš„æ–¹æ³•åˆ†åˆ«æ‰©å±•ClassLoaderå®ä¾‹çš„ä»¥ä¸‹å­—æ®µå³å¯ã€‚</span></span><br><span class="line">            pathField.set(loader, path.toString());</span><br><span class="line">            expandFieldArray(loader, <span class="string">"mPaths"</span>, extraPaths);</span><br><span class="line">            expandFieldArray(loader, <span class="string">"mFiles"</span>, extraFiles);</span><br><span class="line">            expandFieldArray(loader, <span class="string">"mZips"</span>, extraZips);</span><br><span class="line">            expandFieldArray(loader, <span class="string">"mDexs"</span>, extraDexs);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>14 &lt;= Build.VERSION.SDK_INT &lt; 19</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Installer for platform versions 14, 15, 16, 17 and 18.</span></span><br><span class="line"><span class="comment">     */</span><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">V14</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">install</span><span class="params">(ClassLoader loader, List&lt;File&gt; additionalClassPathEntries,</span></span></span><br><span class="line"><span class="function"><span class="params">                File optimizedDirectory)</span></span></span><br><span class="line"><span class="function">                        <span class="keyword">throws</span> IllegalArgumentException, IllegalAccessException,</span></span><br><span class="line"><span class="function">                        NoSuchFieldException, InvocationTargetException, NoSuchMethodException </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰©å±•ClassLoaderå®ä¾‹çš„"pathList"å­—æ®µã€‚</span></span><br><span class="line">            Field pathListField = findField(loader, <span class="string">"pathList"</span>);</span><br><span class="line">            Object dexPathList = pathListField.get(loader);</span><br><span class="line">            expandFieldArray(dexPathList, <span class="string">"dexElements"</span>, makeDexElements(dexPathList,</span><br><span class="line">                    <span class="keyword">new</span> ArrayList&lt;File&gt;(additionalClassPathEntries), optimizedDirectory));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> Object[] makeDexElements(</span><br><span class="line">                Object dexPathList, ArrayList&lt;File&gt; files, File optimizedDirectory)</span><br><span class="line">                        <span class="keyword">throws</span> IllegalAccessException, InvocationTargetException,</span><br><span class="line">                        NoSuchMethodException &#123;</span><br><span class="line">            Method makeDexElements =</span><br><span class="line">                    findMethod(dexPathList, <span class="string">"makeDexElements"</span>, ArrayList<span class="class">.<span class="keyword">class</span>, <span class="title">File</span>.<span class="title">class</span>)</span>;</span><br><span class="line">            <span class="keyword">return</span> (Object[]) makeDexElements.invoke(dexPathList, files, optimizedDirectory);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>ä» API14 å¼€å§‹ï¼ŒDexClassLoader ä¼šä½¿ç”¨ä¸€ä¸ª DexpDexPathList ç±»æ¥å°è£… DexFile æ•°ç»„ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DexPathList</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEX_SUFFIX = <span class="string">".dex"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String JAR_SUFFIX = <span class="string">".jar"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String ZIP_SUFFIX = <span class="string">".zip"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String APK_SUFFIX = <span class="string">".apk"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Element[] makeDexElements(ArrayList&lt;File&gt; files,</span><br><span class="line">            File optimizedDirectory) &#123;</span><br><span class="line">        ArrayList&lt;Element&gt; elements = <span class="keyword">new</span> ArrayList&lt;Element&gt;();</span><br><span class="line">        <span class="keyword">for</span> (File file : files) &#123;</span><br><span class="line">            ZipFile zip = <span class="keyword">null</span>;</span><br><span class="line">            DexFile dex = <span class="keyword">null</span>;</span><br><span class="line">            String name = file.getName();</span><br><span class="line">            <span class="keyword">if</span> (name.endsWith(DEX_SUFFIX)) &#123;</span><br><span class="line"><span class="comment">// Raw dex file (not inside a zip/jar).try &#123;</span></span><br><span class="line">                    dex = loadDexFile(file, optimizedDirectory);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">                    System.logE(<span class="string">"Unable to load dex file: "</span> + file, ex);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (name.endsWith(APK_SUFFIX) || name.endsWith(JAR_SUFFIX)</span><br><span class="line">                    || name.endsWith(ZIP_SUFFIX)) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    zip = <span class="keyword">new</span> ZipFile(file);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">                    System.logE(<span class="string">"Unable to open zip file: "</span> + file, ex);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    dex = loadDexFile(file, optimizedDirectory);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException ignored) &#123;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                System.logW(<span class="string">"Unknown file type for: "</span> + file);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ((zip != <span class="keyword">null</span>) || (dex != <span class="keyword">null</span>)) &#123;</span><br><span class="line">                elements.add(<span class="keyword">new</span> Element(file, zip, dex));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> elements.toArray(<span class="keyword">new</span> Element[elements.size()]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> DexFile <span class="title">loadDexFile</span><span class="params">(File file, File optimizedDirectory)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (optimizedDirectory == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> DexFile(file);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            String optimizedPath = optimizedPathFor(file, optimizedDirectory);</span><br><span class="line">            <span class="keyword">return</span> DexFile.loadDex(file.getPath(), optimizedPath, <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡è°ƒç”¨ <strong>DexPathList#makeDexElements</strong> æ–¹æ³•ï¼Œå¯ä»¥åŠ è½½æˆ‘ä»¬ä¸Šé¢è§£å‹å¾—åˆ°çš„ dex æ–‡ä»¶ï¼Œä»ä»£ç ä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œ<strong>DexPathList#makeDexElements</strong> å…¶å®ä¹Ÿæ˜¯é€šè¿‡è°ƒç”¨ <strong>DexFile#loadDex</strong> æ¥åŠ è½½ dex æ–‡ä»¶å¹¶åˆ›å»º DexFile å¯¹è±¡çš„ã€‚V14 ä¸­ï¼Œé€šè¿‡åå°„è°ƒç”¨ <strong>DexPathList#makeDexElements</strong> æ–¹æ³•åŠ è½½æˆ‘ä»¬éœ€è¦çš„ dex æ–‡ä»¶ï¼Œåœ¨æŠŠåŠ è½½å¾—åˆ°çš„æ•°ç»„æ‰©å±•åˆ° ClassLoader å®ä¾‹çš„ â€œpathListâ€ å­—æ®µï¼Œä»è€Œå®Œæˆ dex æ–‡ä»¶çš„å®‰è£…ã€‚</p>
<p>ä» DexPathList çš„ä»£ç ä¸­æˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹å‡ºï¼ŒClassLoader æ˜¯æ”¯æŒç›´æ¥åŠ è½½.dex/.zip/.jar/.apk çš„ dex æ–‡ä»¶åŒ…çš„ï¼ˆæˆ‘è®°å¾—ä»¥å‰åœ¨å“ªç¯‡æ—¥å¿—ä¸­å¥½åƒæåˆ°è¿‡ç±»ä¼¼çš„é—®é¢˜â€¦ï¼‰ã€‚</p>
<p>19 &lt;= Build.VERSION.SDK_INT</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Installer for platform versions 19.</span></span><br><span class="line"><span class="comment">     */</span><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">V19</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">install</span><span class="params">(ClassLoader loader, List&lt;File&gt; additionalClassPathEntries,</span></span></span><br><span class="line"><span class="function"><span class="params">                File optimizedDirectory)</span></span></span><br><span class="line"><span class="function">                        <span class="keyword">throws</span> IllegalArgumentException, IllegalAccessException,</span></span><br><span class="line"><span class="function">                        NoSuchFieldException, InvocationTargetException, NoSuchMethodException </span>&#123;</span><br><span class="line"></span><br><span class="line">            Field pathListField = findField(loader, <span class="string">"pathList"</span>);</span><br><span class="line">            Object dexPathList = pathListField.get(loader);</span><br><span class="line">            ArrayList&lt;IOException&gt; suppressedExceptions = <span class="keyword">new</span> ArrayList&lt;IOException&gt;();</span><br><span class="line">            expandFieldArray(dexPathList, <span class="string">"dexElements"</span>, makeDexElements(dexPathList,</span><br><span class="line">                    <span class="keyword">new</span> ArrayList&lt;File&gt;(additionalClassPathEntries), optimizedDirectory,</span><br><span class="line">                    suppressedExceptions));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (suppressedExceptions.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (IOException e : suppressedExceptions) &#123;</span><br><span class="line">                    Log.w(TAG, <span class="string">"Exception in makeDexElement"</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">                Field suppressedExceptionsField =</span><br><span class="line">                        findField(dexPathList, <span class="string">"dexElementsSuppressedExceptions"</span>);</span><br><span class="line">                IOException[] dexElementsSuppressedExceptions =</span><br><span class="line">                        (IOException[]) suppressedExceptionsField.get(dexPathList);</span><br><span class="line">                <span class="keyword">if</span> (dexElementsSuppressedExceptions == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    dexElementsSuppressedExceptions =</span><br><span class="line">                            suppressedExceptions.toArray(</span><br><span class="line">                                    <span class="keyword">new</span> IOException[suppressedExceptions.size()]);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    IOException[] combined =</span><br><span class="line">                            <span class="keyword">new</span> IOException[suppressedExceptions.size() +</span><br><span class="line">                                            dexElementsSuppressedExceptions.length];</span><br><span class="line">                    suppressedExceptions.toArray(combined);</span><br><span class="line">                    System.arraycopy(dexElementsSuppressedExceptions, <span class="number">0</span>, combined,</span><br><span class="line">                            suppressedExceptions.size(), dexElementsSuppressedExceptions.length);</span><br><span class="line">                    dexElementsSuppressedExceptions = combined;</span><br><span class="line">                &#125;</span><br><span class="line">                suppressedExceptionsField.set(dexPathList, dexElementsSuppressedExceptions);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> Object[] makeDexElements(</span><br><span class="line">                Object dexPathList, ArrayList&lt;File&gt; files, File optimizedDirectory,</span><br><span class="line">                ArrayList&lt;IOException&gt; suppressedExceptions)</span><br><span class="line">                        <span class="keyword">throws</span> IllegalAccessException, InvocationTargetException,</span><br><span class="line">                        NoSuchMethodException &#123;</span><br><span class="line">            Method makeDexElements =</span><br><span class="line">                    findMethod(dexPathList, <span class="string">"makeDexElements"</span>, ArrayList<span class="class">.<span class="keyword">class</span>, <span class="title">File</span>.<span class="title">class</span>,</span></span><br><span class="line"><span class="class">                            <span class="title">ArrayList</span>.<span class="title">class</span>)</span>;</span><br><span class="line">            <span class="keyword">return</span> (Object[]) makeDexElements.invoke(dexPathList, files, optimizedDirectory,</span><br><span class="line">                    suppressedExceptions);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>V19 ä¸ V14 å·®åˆ«ä¸å¤§ï¼Œåªä¸è¿‡ <strong>DexPathList#makeDexElements</strong> æ–¹æ³•å¤šäº†ä¸€ä¸ª ArrayList å‚æ•°ï¼Œå¦‚æœåœ¨æ‰§è¡Œ <strong>DexPathList#makeDexElements</strong> æ–¹æ³•çš„è¿‡ç¨‹ä¸­å‡ºç°å¼‚å¸¸ï¼Œåé¢ä½¿ç”¨åå°„çš„æ–¹å¼æŠŠè¿™äº›å¼‚å¸¸è®°å½•è¿› DexPathList çš„ <strong>dexElementsSuppressedExceptions</strong> å­—æ®µé‡Œé¢ã€‚</p>
<p>æ— è®ºæ˜¯ V4/V14 è¿˜æ˜¯ V19ï¼Œåœ¨åˆ›å»º DexFile å¯¹è±¡çš„æ—¶å€™ï¼Œéƒ½éœ€è¦é€šè¿‡ DexFile çš„ Native æ–¹æ³• <strong>openDexFile</strong> æ¥æ‰“å¼€ dex æ–‡ä»¶ï¼Œå…¶å…·ä½“ç»†èŠ‚æš‚ä¸è®¨è®ºï¼ˆæ¶‰åŠåˆ° dex çš„æ–‡ä»¶ç»“æ„ï¼Œå¾ˆçƒ¦ï¼Œæœ‰å…´è¶£è¯·é˜…è¯» <a href="https://android.googlesource.com/platform/dalvik/+/0dcf6bb/vm/native/dalvik_system_DexFile.cpp" target="_blank" rel="noopener">dalvik_system_DexFile.cpp</a>ï¼‰ï¼Œè¿™ä¸ªè¿‡ç¨‹çš„ä¸»è¦ç›®çš„æ˜¯ç»™å½“å‰çš„ dex æ–‡ä»¶åš Optimize ä¼˜åŒ–å¤„ç†å¹¶ç”Ÿæˆç›¸åŒæ–‡ä»¶åçš„ odex æ–‡ä»¶ï¼ŒApp å®é™…åŠ è½½ç±»çš„æ—¶å€™ï¼Œéƒ½æ˜¯é€šè¿‡ odex æ–‡ä»¶è¿›è¡Œçš„ã€‚å› ä¸ºæ¯ä¸ªè®¾å¤‡å¯¹ odex æ ¼å¼çš„è¦æ±‚éƒ½ä¸ä¸€æ ·ï¼Œæ‰€ä»¥è¿™ä¸ªä¼˜åŒ–çš„æ“ä½œåªèƒ½æ”¾åœ¨å®‰è£… Apk çš„æ—¶å€™å¤„ç†ï¼Œä¸» dex çš„ä¼˜åŒ–æˆ‘ä»¬å·²ç»åœ¨å®‰è£… apk çš„æ—¶å€™æå®šäº†ï¼Œå…¶ä½™çš„ dex å°±æ˜¯åœ¨ <code>MultiDex#installSecondaryDexes</code> é‡Œé¢ä¼˜åŒ–çš„ï¼Œè€Œåè€…ä¹Ÿæ˜¯ MultiDex è¿‡ç¨‹ä¸­ï¼Œå¦å¤–ä¸€ä¸ªè€—æ—¶æ¯”è¾ƒå¤šçš„æ“ä½œã€‚ï¼ˆåœ¨ MultiDex ä¸­ï¼Œæå–å‡ºæ¥çš„ dex æ–‡ä»¶è¢«å‹ç¼©æˆ.zip æ–‡ä»¶ï¼Œåˆä¼˜åŒ–åçš„ odex æ–‡ä»¶åˆ™è¢«ä¿å­˜ä¸º.dex æ–‡ä»¶ã€‚ï¼‰</p>
<p>åˆ°è¿™é‡Œï¼ŒMultiDex çš„å·¥ä½œæµç¨‹å°±ç»“æŸäº†ã€‚æ€ä¹ˆæ ·ï¼Œæ˜¯ä¸æ˜¯è§‰å¾—å’Œä»¥å‰è°ˆåˆ°åŠ¨æ€åŠ è½½æŠ€æœ¯ï¼ˆæ’ä»¶åŒ–ï¼‰çš„æ—¶å€™è¯´çš„å¾ˆåƒï¼Ÿæ²¡é”™ï¼Œè°å«å®ƒä»¬çš„æ ¸å¿ƒéƒ½æ˜¯ dex æ–‡ä»¶å‘¢ã€‚Java è€å¸ˆç¬¬ä¸€èŠ‚è¯¾å°±è¯´ â€œ<strong> ç±»å°±æ˜¯ç¼–ç¨‹ </strong>â€ï¼Œæå®šç±»ä½ å°±èƒ½æå®šæ•´ä¸ªä¸–ç•Œå•Šï¼</p>
<h2 id="ä¼˜åŒ–æ–¹æ¡ˆ"><a href="#ä¼˜åŒ–æ–¹æ¡ˆ" class="headerlink" title="ä¼˜åŒ–æ–¹æ¡ˆ"></a>ä¼˜åŒ–æ–¹æ¡ˆ</h2><p>MultiDex æœ‰ä¸ªæ¯”è¾ƒè›‹ç–¼çš„é—®é¢˜ï¼Œå°±æ˜¯ä¼šäº§ç”Ÿæ˜æ˜¾çš„å¡é¡¿ç°è±¡ï¼Œé€šè¿‡ä¸Šé¢çš„åˆ†æï¼Œæˆ‘ä»¬çŸ¥é“å…·ä½“çš„å¡é¡¿äº§ç”Ÿåœ¨ <strong> è§£å‹ dex æ–‡ä»¶ </strong> ä»¥åŠ <strong> ä¼˜åŒ– dex</strong> ä¸¤ä¸ªæ­¥éª¤ã€‚ä¸è¿‡å¥½åœ¨ï¼Œåœ¨ Application#attachBaseContext (Context) ä¸­ï¼ŒUI çº¿ç¨‹çš„é˜»å¡æ˜¯ä¸ä¼šå¼•å‘ ANR çš„ï¼Œåªä¸è¿‡è¿™æ®µé•¿æ—¶é—´çš„å¡é¡¿ï¼ˆç™½å±ï¼‰è¿˜æ˜¯ä¼šå½±å“ç”¨æˆ·ä½“éªŒã€‚<br>ç›®å‰ï¼Œä¼˜åŒ–æ–¹æ¡ˆèƒ½æƒ³åˆ°çš„æœ‰ä¸¤ç§ã€‚</p>
<h3 id="PreMultiDex-æ–¹æ¡ˆ"><a href="#PreMultiDex-æ–¹æ¡ˆ" class="headerlink" title="PreMultiDex æ–¹æ¡ˆ"></a>PreMultiDex æ–¹æ¡ˆ</h3><p>å¤§è‡´æ€è·¯æ˜¯ï¼Œåœ¨å®‰è£…ä¸€ä¸ªæ–°çš„ apk çš„æ—¶å€™ï¼Œå…ˆåœ¨ Worker çº¿ç¨‹é‡Œåšå¥½ MultiDex çš„è§£å‹å’Œ Optimize å·¥ä½œï¼Œå®‰è£… apk å¹¶å¯åŠ¨åï¼Œç›´æ¥ä½¿ç”¨ä¹‹å‰ Optimize äº§ç”Ÿçš„ odex æ–‡ä»¶ï¼Œè¿™æ ·å°±å¯ä»¥é¿å…ç¬¬ä¸€æ¬¡å¯åŠ¨æ—¶å€™çš„ Optimize å·¥ä½œã€‚</p>
<p><img src="/assets/02dd6659_1487_4691_a0a6_d9c1ad849079_untitled.png" alt></p>
<p>å®‰è£… dex çš„æ—¶å€™ï¼Œæ ¸å¿ƒæ˜¯åˆ›å»º DexFile å¯¹è±¡å¹¶ä½¿ç”¨å…¶ Native æ–¹æ³•å¯¹ dex æ–‡ä»¶è¿›è¡Œ opt å¤„ç†ï¼ŒåŒæ—¶ç”Ÿäº§ä¸€ä¸ªä¸ dex æ–‡ä»¶ï¼ˆ.zipï¼‰åŒåçš„å·²ç» opt è¿‡çš„ dex æ–‡ä»¶ï¼ˆ.dexï¼‰ã€‚å¦‚æœå®‰è£… dex çš„æ—¶å€™ï¼Œè¿™ä¸ª opt è¿‡çš„ dex æ–‡ä»¶å·²ç»å­˜åœ¨ï¼Œåˆ™è·³è¿‡è¿™ä¸ªè¿‡ç¨‹ï¼Œè¿™ä¼šèŠ‚çœè®¸å¤šè€—æ—¶ã€‚æ‰€ä»¥ä¼˜åŒ–çš„æ€è·¯å°±æ˜¯ï¼Œä¸‹è½½ Apk å®Œæˆçš„æ—¶å€™ï¼Œé¢„å…ˆè§£å‹ dex æ–‡ä»¶ï¼Œå¹¶é¢„å…ˆè§¦å‘å®‰è£… dex æ–‡ä»¶ä»¥ç”Ÿäº§ opt è¿‡çš„ dex æ–‡ä»¶ã€‚è¿™æ ·è¦†ç›–å®‰è£… Apk å¹¶å¯åŠ¨çš„æ—¶å€™ï¼Œå¦‚æœ MultiDex èƒ½å‘½ä¸­è§£å‹å¥½çš„ dex å’Œ odex æ–‡ä»¶ï¼Œåˆ™èƒ½é¿å¼€è€—æ—¶æœ€å¤§çš„ä¸¤ä¸ªæ“ä½œã€‚</p>
<p>ä¸è¿‡è¿™ä¸ªæ–¹æ¡ˆçš„ç¼ºç‚¹ä¹Ÿæ˜¯æ˜æ˜¾çš„ï¼Œç¬¬ä¸€æ¬¡å®‰è£…çš„ apk æ²¡æœ‰ä½œç”¨ï¼Œè€Œä¸”äº‹å…ˆéœ€è¦ä½¿ç”¨å†…ç½®çš„ apk æ›´æ–°åŠŸèƒ½æŠŠæ–°ç‰ˆæœ¬çš„ apk æ–‡ä»¶ä¸‹è½½ä¸‹æ¥åï¼Œæ‰èƒ½åš PreMultiDex å·¥ä½œã€‚</p>
<h3 id="å¼‚æ­¥-MultiDex-æ–¹æ¡ˆ"><a href="#å¼‚æ­¥-MultiDex-æ–¹æ¡ˆ" class="headerlink" title="å¼‚æ­¥ MultiDex æ–¹æ¡ˆ"></a>å¼‚æ­¥ MultiDex æ–¹æ¡ˆ</h3><p>è¿™ç§æ–¹æ¡ˆä¹Ÿæ˜¯ç›®å‰æ¯”è¾ƒæµè¡Œçš„ <strong>Dex æ‰‹åŠ¨åˆ†åŒ…æ–¹æ¡ˆ </strong>ï¼Œå¯åŠ¨ App çš„æ—¶å€™ï¼Œå…ˆæ˜¾ç¤ºä¸€ä¸ªç®€å•çš„ Splash é—ªå±ç•Œé¢ï¼Œç„¶åå¯åŠ¨ Worker çº¿ç¨‹æ‰§è¡Œ MultiDex#install (Context) å·¥ä½œï¼Œå°±å¯ä»¥é¿å… UI çº¿ç¨‹é˜»å¡ã€‚ä¸è¿‡è¦ç¡®ä¿å¯åŠ¨ä»¥åŠå¯åŠ¨ MultiDex#install (Context) æ‰€éœ€è¦çš„ç±»éƒ½åœ¨ä¸» dex é‡Œé¢ï¼ˆæ‰‹åŠ¨åˆ†åŒ…ï¼‰ï¼Œè€Œä¸”éœ€è¦å¤„ç†å¥½è¿›ç¨‹åŒæ­¥é—®é¢˜ã€‚</p>
<p>å‚è€ƒèµ„æ–™ï¼š</p>
<ul>
<li><a href="https://developer.android.com/studio/build/multidex.html" target="_blank" rel="noopener">Configure Apps with Over 64K Methods</a></li>
<li><a href="https://android.googlesource.com/platform/frameworks/multidex/" target="_blank" rel="noopener">Google Multidex</a></li>
<li><a href="https://android.googlesource.com/platform/dalvik/+/0dcf6bb/vm/native/dalvik_system_DexFile.cpp" target="_blank" rel="noopener">dalvik_system_DexFile.cpp</a></li>
</ul>
<!-- Generated by HexoWriter
notion-down.version = 1.0.0
notion-down.revision = b'df2b844'
Title = MultiDex å·¥ä½œåŸç†åˆ†æå’Œä¼˜åŒ–æ–¹æ¡ˆ
Date = 2016-11-11 00:00:00
Published = true
Category = Android
Tag = ['Android', 'MultiDex', 'æºç åˆ†æ']
FileLocate = android
FileName = multidex-source-code
hexo.comments = true
-->

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/Android/">Android</a>
    </span>
    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/Android/">Android</a><a href="/tags/æºç åˆ†æ/">æºç åˆ†æ</a><a href="/tags/MultiDex/">MultiDex</a>
    </span>
    

    </div>

    
  </div>
</article>

  



	<section id="comment" class="comment">
	  <div id="disqus_thread">
	  <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
	  </div>
	</section>

	<script type="text/javascript">
	var disqus_shortname = 'kidhaibara';
	(function(){
	  var dsq = document.createElement('script');
	  dsq.type = 'text/javascript';
	  dsq.async = true;
	  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
	  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	}());
	(function(){
	  var dsq = document.createElement('script');
	  dsq.type = 'text/javascript';
	  dsq.async = true;
	  dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
	  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	}());
	</script>




    </main>

    <footer class="site-footer">
  <p class="site-info">
    Deployed by <a href="https://github.com/kaedea/notion-down" target="_blank">notion-down</a> and
    Theme by <a href="https://github.com/kaedea/hexo-theme-hacker" target="_blank">hexo-theme-hacker</a>
    </br>
    
    &copy; 2025 Kaede Akatsuki
    
  </p>
</footer>
    
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'G-J38N5N288S', 'auto');
    ga('send', 'pageview');

</script>

  </div>
</div>
</body>
</html>