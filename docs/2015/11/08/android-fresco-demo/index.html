<!DOCTYPE HTML>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  
  <title>Facebook 开源图片加载库 Fresco Demo | Kaede Akatsuki | 中二病也要开发 Android</title>

  
  <meta name="author" content="Kaede Akatsuki">
  

  
  <meta name="description" content="A TASTE OF ACG (Anime/Coding/Games).">
  

  
  
  <meta name="keywords" content="Android,Fresco,Demo,GitHub">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="Facebook 开源图片加载库 Fresco Demo">

  <meta property="og:site_name" content="Kaede Akatsuki">

  
  <meta property="og:image" content="/favicon.ico">
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="Kaede Akatsuki" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
</head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">Kaede Akatsuki</a>
    </h1>
    <p class="site-description">中二病也要开发 Android</p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/archives">归档</a></li>
      
        <li><a href="/categories">分类</a></li>
      
        <li><a href="/about">关于</a></li>
      
        <li><a href="/atom.xml">订阅</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    <article>

  
    
    <h3 class="article-title"><span>Facebook 开源图片加载库 Fresco Demo</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2015/11/08/android-fresco-demo/" rel="bookmark">
        <time class="entry-date published" datetime="2015-11-08T00:00:00.000Z">
          2015-11-08
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p><img src="/assets/ceddf533_e36c_4640_aac1_7388048d9b20_untitled.png" alt></p>
<p>现在市面上各种图片加载库，性能其实相差不是很大，最主要的区别还是使用方式的复杂程度。Fresco 使用起来非常简单，也容易扩展，然而这并不是我喜欢 Fresco 的主要原因。</p>
<a id="more"></a>
<h3 id="基本信息"><a href="#基本信息" class="headerlink" title="基本信息"></a>基本信息</h3><p>GitHub : <a href="https://github.com/kaedea/Fresco-Sample-Usage" target="_blank" rel="noopener">Fresco Sample Usage</a><br>作者 : <a href="https://github.com/kaedea" target="_blank" rel="noopener">Kaede</a><br>参考 : <a href="https://github.com/facebook/fresco" target="_blank" rel="noopener">fresco</a> <a href="https://github.com/06peng/FrescoDemo" target="_blank" rel="noopener">06peng</a> <a href="http://frescolib.org/" target="_blank" rel="noopener">frescolib.org</a></p>
<h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>关于图片加载框架，我用过许多轮子，也有自己写过。目前项目在使用的是一个我基于 Volley 修改而来的 ImageLoader ，但是由于产品天花乱坠的需求，现在已经渐渐改得面目全非了，于是打算换成一个新的轮子，在 Glide 和 Fresco 纠结一段时间后，打算先尝试 Fresco 。</p>
<p>图片加载框架如果不处理好 Bitmap 的缓存问题就容易引发 Bitmap 泄露，Bitmap 泄露是 Android 内存泄露的一大原因，而内存泄露又是 OOM 的主要原因。</p>
<p>Bitmap 是非常占用内存的，比普通的 Java 对象大多了，不释放的话很快就 OOM 了；如果释放过早，如果有 ImageView 还用着被释放的 Bitmap，当这个 ImageView 被重绘的时候就会抛 IllegalState 异常。OOM 和 IllegalState 可是为我项目的崩溃率贡献了好多数据。</p>
<p>Android 3.0 (Honeycomb) 之前，系统把 Bitmap 的像素数据放在 Native 层，所以图片加载框架必须手动做好这些 Bitmap 的释放工作，Honeycomb 之后这些放在虚拟机 Heap 里，虚拟机会帮我们回收，所以可以不用手动释放。但是由于 Bitmap 本身非常占用虚拟机的内存，虚拟机的内存很快就不够用了，所以会频繁触发虚拟机的 GC (Garbage Collector)，然而 GC 是非常耗性能的工作，因此也会造成 APP 的卡顿。好在，Android 5.0 (Lollipop) 已经妥善解决这个问题了。</p>
<p>对于 Honeycomb 之前的 Bitmap 缓存问题，目前我项目的轮子使用的处理方式是 Google 推荐的方案，简单说一下就是：设置一个 count，如果一个 Bitmap 被 set 进一个 ImageView 就 + 1，remove 放就 - 1，定期检查这些 Bitmap，如果 count&lt;=0 就回收掉。这个方法能通过测试妹子 “机の宝库” 的考验，无奈在用户的崩溃日志上看起来还是有导致 OOM 和 IllegalState 的情况（天朝水深火日的生态啊），而且这一方法并不能解决 Lollipop 之前频繁 GC 造成的卡顿问题。</p>
<p>之所以想换 Fresco 最主要的原因是：</p>
<blockquote>
<p>Fresco 会在 Lollipop 之前，把 Bitmap 放在 Ashmem（系统匿名共享内存），在图片不显示的时候，占用的内存会自动被释放，不需要手动释放，也不会频繁触发 GC！这会使得 APP 更加流畅，减少因图片内存占用而引发的 OOM，也能有效避免 IllegalState，而且在 Honeycomb 之前的 Android 版本的表现也同样优秀（官方宣称）。</p>
</blockquote>
<p>总之先把源码看一下，拿来用用看，用数据说话吧。目前只写了一个 Demo 项目，后续打算把笔记整理一下，写成一篇日志。</p>
<h3 id="Fresco-简介"><a href="#Fresco-简介" class="headerlink" title="Fresco 简介"></a>Fresco 简介</h3><p><a href="https://github.com/facebook/fresco" target="_blank" rel="noopener">Fresco</a> 是 Facebook 开源的一个强大的 Android 图片加载框架，本项目是一个 Fresco 用法的 Demo 项目。</p>
<h3 id="项目内容"><a href="#项目内容" class="headerlink" title="项目内容"></a>项目内容</h3><ul>
<li>简单地加载一张图片</li>
<li>自定义图片的加载，比如 ScaleType, Rounded Corner, Circle, Fade Animation, Placeholder, Failure Image, Retry Image, ProgressBar, PressedState Overlay</li>
<li>加载 Gif 以及 WebPng 动态图片</li>
<li>监听图片加载的过程</li>
<li>渐进式图片加载</li>
<li>调整图片大小</li>
<li>加载图片后对图片做一些处理</li>
<li>在 ListView 上的使用</li>
<li>在 RecyclerView 上的使用</li>
<li>配合第三方图片控件的使用（PhotoView, SubsamplingSacleImageView, GifDrawable）</li>
<li>相关代码段</li>
</ul>
<h3 id="Fresco-的特性"><a href="#Fresco-的特性" class="headerlink" title="Fresco 的特性"></a>Fresco 的特性</h3><ul>
<li>完善的内存缓存和释放机制</li>
<li>渐进式图片加载</li>
<li>动图支持</li>
<li>可高度自定义的 UI</li>
<li>可高度自定义的图片加载过程</li>
</ul>
<p>详细信息可以参考 <a href="http://frescolib.org/" target="_blank" rel="noopener">frescolib.org</a></p>
<h3 id="预览"><a href="#预览" class="headerlink" title="预览"></a>预览</h3><p><img src="/assets/55c526dd_43d6_44ec_89a1_57d8dabb389a_untitled.png" alt></p>
<p><img src="/assets/4836a887_8427_4574_93ad_73a5c6965846_untitled.png" alt></p>
<!-- Generated by HexoWriter
notion-down.version = 0.1.0
notion-down.revision = b'074303e'
Title = Facebook 开源图片加载库 Fresco Demo
Date = 2015-11-08 00:00:00
Published = true
Category = Android
Tag = ['Android', 'Fresco', 'Demo', 'GitHub']
FileLocate = 
FileName = android-fresco-demo
hexo.comments = true
hexo.metaAlignment = center
-->

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/Android/">Android</a>
    </span>
    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/Android/">Android</a><a href="/tags/Fresco/">Fresco</a><a href="/tags/Demo/">Demo</a><a href="/tags/GitHub/">GitHub</a>
    </span>
    

    </div>

    
  </div>
</article>

  



	<section id="comment" class="comment">
	  <div id="disqus_thread">
	  <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
	  </div>
	</section>

	<script type="text/javascript">
	var disqus_shortname = 'kidhaibara';
	(function(){
	  var dsq = document.createElement('script');
	  dsq.type = 'text/javascript';
	  dsq.async = true;
	  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
	  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	}());
	(function(){
	  var dsq = document.createElement('script');
	  dsq.type = 'text/javascript';
	  dsq.async = true;
	  dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
	  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	}());
	</script>




    </main>

    <footer class="site-footer">
  <p class="site-info">
    Deployed by <a href="https://github.com/kaedea/notion-down" target="_blank">NotionDown</a> and
    Theme by <a href="https://github.com/kaedea/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2021 Kaede Akatsuki
    
  </p>
</footer>
    
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'G-J38N5N288S', 'auto');
    ga('send', 'pageview');

</script>

  </div>
</div>
</body>
</html>